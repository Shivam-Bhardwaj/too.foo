name: Auto-Close Issue on PR Merge

on:
  pull_request:
    types: [closed]

jobs:
  close-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    steps:
      - name: Check if PR was merged
        id: check-merged
        run: |
          if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            echo "merged=true" >> $GITHUB_OUTPUT
          else
            echo "merged=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract issue numbers from PR body
        id: extract-issues
        if: steps.check-merged.outputs.merged == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            // Match "Closes #123" or "Fixes #123" patterns
            const issueMatches = prBody.match(/(?:closes?|fixes?|resolves?)\s+#(\d+)/gi);
            const issueNumbers = [];
            
            if (issueMatches) {
              issueMatches.forEach(match => {
                const number = match.match(/#(\d+)/)[1];
                if (number && !issueNumbers.includes(number)) {
                  issueNumbers.push(number);
                }
              });
            }
            
            core.setOutput('issue_numbers', issueNumbers.join(','));
            console.log(`Found issue numbers to close: ${issueNumbers.join(', ')}`);
            
            return issueNumbers;

      - name: Close linked issues
        if: steps.check-merged.outputs.merged == 'true' && steps.extract-issues.outputs.issue_numbers != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumbers = '${{ steps.extract-issues.outputs.issue_numbers }}'.split(',').filter(n => n);
            const prNumber = context.payload.pull_request.number;
            
            for (const issueNumber of issueNumbers) {
              try {
                // Check if issue is already closed
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber)
                });
                
                if (issue.data.state === 'open') {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    state: 'closed'
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    body: `✅ Issue closed automatically via PR #${prNumber}`
                  });
                  
                  console.log(`✅ Closed issue #${issueNumber}`);
                } else {
                  console.log(`ℹ️  Issue #${issueNumber} is already closed`);
                }
              } catch (error) {
                console.error(`❌ Error closing issue #${issueNumber}:`, error.message);
              }
            }

      - name: Summary
        if: steps.check-merged.outputs.merged == 'true'
        run: |
          echo "## ✅ Auto-Close Issue on PR Merge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR #${{ github.event.pull_request.number }} was merged." >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.extract-issues.outputs.issue_numbers }}" ]; then
            echo "Linked issues closed: ${{ steps.extract-issues.outputs.issue_numbers }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "No linked issues found in PR body." >> $GITHUB_STEP_SUMMARY
          fi



